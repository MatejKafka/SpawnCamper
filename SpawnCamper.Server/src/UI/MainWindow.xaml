<Window x:Class="SpawnCamper.Server.UI.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:SpawnCamper.Server.UI.Converters"
        xmlns:vm="clr-namespace:SpawnCamper.Server.UI.ViewModels"
        mc:Ignorable="d"
        Title="SpawnCamper"
        Width="1100"
        Height="700"
        MinWidth="900"
        MinHeight="500">
    <Window.Resources>
        <converters:TreeLevelToIndentConverter x:Key="TreeLevelToIndentConverter"
                                               IndentSize="18"/>

        <Style x:Key="TreeToggleButtonStyle"
               TargetType="ToggleButton">
            <Setter Property="Focusable"
                    Value="False"/>
            <Setter Property="Width"
                    Value="16"/>
            <Setter Property="Height"
                    Value="16"/>
            <Setter Property="Padding"
                    Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border Background="Transparent">
                            <Grid Width="16"
                                  Height="16"
                                  HorizontalAlignment="Center"
                                  VerticalAlignment="Center">
                                <Path x:Name="Arrow"
                                      Fill="{DynamicResource {x:Static SystemColors.ControlTextBrushKey}}"
                                      Data="M5,4 L11,8 L5,12 Z"
                                      RenderTransformOrigin="0.5,0.5">
                                    <Path.RenderTransform>
                                        <RotateTransform Angle="0"/>
                                    </Path.RenderTransform>
                                </Path>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked"
                                     Value="True">
                                <Setter TargetName="Arrow"
                                        Property="RenderTransform">
                                    <Setter.Value>
                                        <RotateTransform Angle="90"/>
                                    </Setter.Value>
                                </Setter>
                            </Trigger>
                            <Trigger Property="IsEnabled"
                                     Value="False">
                                <Setter TargetName="Arrow"
                                        Property="Fill"
                                        Value="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="AlignedTreeViewItemStyle"
               TargetType="TreeViewItem">
            <Setter Property="IsExpanded"
                    Value="True"/>
            <Setter Property="Background"
                    Value="Transparent"/>
            <Setter Property="BorderBrush"
                    Value="Transparent"/>
            <Setter Property="BorderThickness"
                    Value="0"/>
            <Setter Property="Padding"
                    Value="0"/>
            <Setter Property="Margin"
                    Value="0"/>
            <Setter Property="HorizontalContentAlignment"
                    Value="Stretch"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TreeViewItem">
                        <Grid SnapsToDevicePixels="True">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <Border x:Name="Bd"
                                    Grid.Row="0"
                                    Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    Padding="{TemplateBinding Padding}">
                                <ContentPresenter x:Name="PART_Header"
                                                  ContentSource="Header"
                                                  HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                  SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                            </Border>

                            <ItemsPresenter x:Name="ItemsHost"
                                            Grid.Row="1"
                                            Margin="0"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsExpanded"
                                     Value="False">
                                <Setter TargetName="ItemsHost"
                                        Property="Visibility"
                                        Value="Collapsed"/>
                            </Trigger>
                            <Trigger Property="HasItems"
                                     Value="False">
                                <Setter TargetName="ItemsHost"
                                        Property="Visibility"
                                        Value="Collapsed"/>
                            </Trigger>
                            <Trigger Property="IsSelected"
                                     Value="True">
                                <Setter TargetName="Bd"
                                        Property="Background"
                                        Value="{DynamicResource {x:Static SystemColors.HighlightBrushKey}}"/>
                                <Setter Property="Foreground"
                                        Value="{DynamicResource {x:Static SystemColors.HighlightTextBrushKey}}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled"
                                     Value="False">
                                <Setter Property="Foreground"
                                        Value="{DynamicResource {x:Static SystemColors.GrayTextBrushKey}}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <SolidColorBrush x:Key="DiffAddedBackgroundBrush"
                         Color="#E6FFED"/>
        <SolidColorBrush x:Key="DiffAddedBorderBrush"
                         Color="#ABF2BC"/>
        <SolidColorBrush x:Key="DiffAddedForegroundBrush"
                         Color="#22863A"/>
        <SolidColorBrush x:Key="DiffRemovedBackgroundBrush"
                         Color="#FFEFF0"/>
        <SolidColorBrush x:Key="DiffRemovedBorderBrush"
                         Color="#F5C6CB"/>
        <SolidColorBrush x:Key="DiffRemovedForegroundBrush"
                         Color="#CB2431"/>

        <converters:EnvironmentDifferencesToFlowDocumentConverter x:Key="EnvironmentDifferencesDocumentConverter"
                                                                  AddedForeground="{StaticResource DiffAddedForegroundBrush}"
                                                                  AddedBackground="{StaticResource DiffAddedBackgroundBrush}"
                                                                  RemovedForeground="{StaticResource DiffRemovedForegroundBrush}"
                                                                  RemovedBackground="{StaticResource DiffRemovedBackgroundBrush}"
                                                                  DefaultForeground="{StaticResource {x:Static SystemColors.ControlTextBrushKey}}"/>

        <Style x:Key="SelectableTextBoxStyle"
               TargetType="TextBox">
            <Setter Property="IsReadOnly"
                    Value="True"/>
            <Setter Property="Background"
                    Value="Transparent"/>
            <Setter Property="BorderThickness"
                    Value="0"/>
            <Setter Property="Padding"
                    Value="0"/>
            <Setter Property="Margin"
                    Value="0"/>
            <Setter Property="VerticalContentAlignment"
                    Value="Center"/>
            <Setter Property="HorizontalAlignment"
                    Value="Stretch"/>
            <Setter Property="ScrollViewer.HorizontalScrollBarVisibility"
                    Value="Disabled"/>
            <Setter Property="ScrollViewer.VerticalScrollBarVisibility"
                    Value="Disabled"/>
            <Setter Property="TextWrapping"
                    Value="NoWrap"/>
            <EventSetter Event="PreviewMouseLeftButtonDown"
                         Handler="SelectableTextBox_OnPreviewMouseLeftButtonDown"/>
        </Style>

        <Style x:Key="SelectableKeyTextBoxStyle"
               TargetType="TextBox"
               BasedOn="{StaticResource SelectableTextBoxStyle}">
            <Setter Property="FontWeight"
                    Value="SemiBold"/>
        </Style>

        <HierarchicalDataTemplate x:Key="ProcessNodeTemplate"
                                  DataType="{x:Type vm:ProcessNodeViewModel}"
                                  ItemsSource="{Binding Children}">
            <Grid Margin="0,1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="220"
                                      SharedSizeGroup="BinaryColumn"/>
                    <ColumnDefinition Width="90"
                                      SharedSizeGroup="PidColumn"/>
                    <ColumnDefinition Width="90"
                                      SharedSizeGroup="ExitColumn"/>
                    <ColumnDefinition Width="*"
                                      SharedSizeGroup="CommandColumn"/>
                </Grid.ColumnDefinitions>

                <Grid Grid.Column="0"
                      VerticalAlignment="Center">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="{Binding RelativeSource={RelativeSource AncestorType=TreeViewItem}, Converter={StaticResource TreeLevelToIndentConverter}}"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <ToggleButton Grid.Column="1"
                                  Margin="0,0,6,0"
                                  IsChecked="{Binding IsExpanded, Mode=TwoWay, RelativeSource={RelativeSource AncestorType=TreeViewItem}}"
                                  Focusable="False">
                        <ToggleButton.Style>
                            <Style TargetType="ToggleButton"
                                   BasedOn="{StaticResource TreeToggleButtonStyle}">
                                <Setter Property="Visibility"
                                        Value="Visible"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding HasItems, RelativeSource={RelativeSource AncestorType=TreeViewItem}}"
                                                 Value="False">
                                        <Setter Property="Visibility"
                                                Value="Hidden"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ToggleButton.Style>
                    </ToggleButton>

                    <TextBlock Grid.Column="2"
                               Text="{Binding BinaryNameDisplay}"
                               VerticalAlignment="Center"
                               TextTrimming="CharacterEllipsis"
                               Margin="0,0,12,0">
                        <TextBlock.ToolTip>
                            <StackPanel>
                                <TextBlock Text="{Binding ApplicationName, TargetNullValue=(unknown)}"/>
                                <TextBlock Text="{Binding CommandLine, TargetNullValue=(no command line)}"
                                           TextWrapping="Wrap"/>
                            </StackPanel>
                        </TextBlock.ToolTip>
                    </TextBlock>
                </Grid>

                <TextBlock Grid.Column="1"
                           Text="{Binding ProcessIdDisplay}"
                           VerticalAlignment="Center"
                           FontFamily="Consolas"
                           HorizontalAlignment="Left"
                           Margin="0,0,12,0"/>

                <Grid Grid.Column="2"
                      HorizontalAlignment="Left"
                      Width="80">
                    <ProgressBar Height="12"
                                 IsIndeterminate="True">
                        <ProgressBar.Style>
                            <Style TargetType="ProgressBar">
                                <Setter Property="Visibility"
                                        Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ShowSpinner}"
                                                 Value="True">
                                        <Setter Property="Visibility"
                                                Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ProgressBar.Style>
                    </ProgressBar>
                    <TextBlock Text="{Binding ExitDisplayText}"
                               HorizontalAlignment="Left"
                               VerticalAlignment="Center"
                               FontFamily="Consolas">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility"
                                        Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ShowSpinner}"
                                                 Value="False">
                                        <Setter Property="Visibility"
                                                Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </Grid>

                <TextBlock Grid.Column="3"
                           Text="{Binding CommandLineDisplay}"
                           VerticalAlignment="Center"
                           TextTrimming="CharacterEllipsis"/>
            </Grid>
        </HierarchicalDataTemplate>

        <DataTemplate DataType="{x:Type vm:ProcessNodeViewModel}">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel Margin="8">
                    <TextBox Text="{Binding DisplayLabelSingleLine, Mode=OneWay}"
                             Style="{StaticResource SelectableTextBoxStyle}"
                             FontSize="20"
                             FontWeight="Bold"
                             Margin="0,0,0,16"
                             TextWrapping="NoWrap">
                        <TextBox.ToolTip>
                            <TextBlock Text="{Binding DisplayLabel}"/>
                        </TextBox.ToolTip>
                    </TextBox>

                    <Grid Margin="0,0,0,16">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="160"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0"
                                   Grid.Column="0"
                                   Text="Process ID:"
                                   FontWeight="SemiBold"/>
                        <TextBox Grid.Row="0"
                                 Grid.Column="1"
                                 Text="{Binding ProcessIdDisplay, Mode=OneWay}"
                                 Style="{StaticResource SelectableTextBoxStyle}"/>

                        <TextBlock Grid.Row="1"
                                   Grid.Column="0"
                                   Text="Status:"
                                   FontWeight="SemiBold"/>
                        <TextBox Grid.Row="1"
                                 Grid.Column="1"
                                 Text="{Binding StatusText, Mode=OneWay}"
                                 Style="{StaticResource SelectableTextBoxStyle}"/>

                        <TextBlock Grid.Row="2"
                                   Grid.Column="0"
                                   Text="Exit code:"
                                   FontWeight="SemiBold"/>
                        <TextBox Grid.Row="2"
                                 Grid.Column="1"
                                 Text="{Binding ExitDisplayText, Mode=OneWay}"
                                 Style="{StaticResource SelectableTextBoxStyle}"/>

                        <TextBlock Grid.Row="3"
                                   Grid.Column="0"
                                   Text="Start time:"
                                   FontWeight="SemiBold"/>
                        <TextBox Grid.Row="3"
                                 Grid.Column="1"
                                 Text="{Binding AttachTimeDisplay, Mode=OneWay}"
                                 Style="{StaticResource SelectableTextBoxStyle}"/>

                        <TextBlock Grid.Row="4"
                                   Grid.Column="0"
                                   Text="End time:"
                                   FontWeight="SemiBold"/>
                        <TextBox Grid.Row="4"
                                 Grid.Column="1"
                                 Text="{Binding DetachTimeDisplay, Mode=OneWay}"
                                 Style="{StaticResource SelectableTextBoxStyle}"/>

                        <TextBlock Grid.Row="5"
                                   Grid.Column="0"
                                   Text="Duration:"
                                   FontWeight="SemiBold"/>
                        <TextBox Grid.Row="5"
                                 Grid.Column="1"
                                 Text="{Binding DurationDisplay, Mode=OneWay}"
                                 Style="{StaticResource SelectableTextBoxStyle}"/>

                        <TextBlock Grid.Row="6"
                                   Grid.Column="0"
                                   Text="Application:"
                                   FontWeight="SemiBold"/>
                        <TextBox Grid.Row="6"
                                 Grid.Column="1"
                                 Text="{Binding ApplicationName, Mode=OneWay, TargetNullValue=(unknown)}"
                                 Style="{StaticResource SelectableTextBoxStyle}"
                                 TextWrapping="Wrap"/>

                        <TextBlock Grid.Row="7"
                                   Grid.Column="0"
                                   Text="Working directory:"
                                   FontWeight="SemiBold"/>
                        <TextBox Grid.Row="7"
                                 Grid.Column="1"
                                 Text="{Binding WorkingDirectory, Mode=OneWay, TargetNullValue=(not reported)}"
                                 Style="{StaticResource SelectableTextBoxStyle}"
                                 TextWrapping="Wrap"/>

                        <TextBlock Grid.Row="8"
                                   Grid.Column="0"
                                   Text="Failure:"
                                   FontWeight="SemiBold">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility"
                                            Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsCreationFailure}"
                                                     Value="True">
                                            <Setter Property="Visibility"
                                                    Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        <TextBox Grid.Row="5"
                                 Grid.Column="1"
                                 Text="{Binding FailureReason, Mode=OneWay}"
                                 TextWrapping="Wrap">
                            <TextBox.Style>
                                <Style TargetType="TextBox"
                                       BasedOn="{StaticResource SelectableTextBoxStyle}">
                                    <Setter Property="TextWrapping"
                                            Value="Wrap"/>
                                    <Setter Property="Visibility"
                                            Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsCreationFailure}"
                                                     Value="True">
                                            <Setter Property="Visibility"
                                                    Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBox.Style>
                        </TextBox>
                    </Grid>

                    <StackPanel Orientation="Horizontal"
                                Margin="0,0,0,12">
                        <Button Content="Copy full invocation"
                                Command="{Binding CopyFullInvocationCommand}"
                                VerticalAlignment="Center"
                                Background="#E8E8E8"
                                BorderBrush="#CCCCCC"
                                BorderThickness="1"
                                Padding="8,4"
                                Cursor="Hand"
                                ToolTip="Copy complete PowerShell script with environment, working directory, and command">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver"
                                                 Value="True">
                                            <Setter Property="Background"
                                                    Value="#D8D8D8"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>


                        <!-- Split WinDbg button - visually combined but two separate clickable areas -->
                        <Border BorderBrush="#CCCCCC"
                                BorderThickness="1"
                                CornerRadius="3"
                                Margin="8,0,0,0">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="1"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Main button - Launch in WinDbg (auto-run) -->
                                <Button Grid.Column="0"
                                        Content="WinDbg"
                                        Command="{Binding LaunchInWinDbgCommand}"
                                        VerticalAlignment="Stretch"
                                        Background="#E8F4E8"
                                        BorderThickness="0"
                                        Padding="8,4"
                                        Cursor="Hand"
                                        ToolTip="Launch in WinDbg (auto-run)">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver"
                                                         Value="True">
                                                    <Setter Property="Background"
                                                            Value="#D8E8D8"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>

                                <!-- Separator -->
                                <Rectangle Grid.Column="1"
                                           Fill="#CCCCCC"
                                           Width="1"/>

                                <!-- Secondary button - Break on start -->
                                <Button Grid.Column="2"
                                        Content="(break)"
                                        Command="{Binding LaunchInWinDbgBreakCommand}"
                                        VerticalAlignment="Stretch"
                                        Background="#E8F4E8"
                                        BorderThickness="0"
                                        Padding="6,4"
                                        Cursor="Hand"
                                        ToolTip="Launch in WinDbg and break on process start">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver"
                                                         Value="True">
                                                    <Setter Property="Background"
                                                            Value="#D8E8D8"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>
                            </Grid>
                        </Border>

                        <!-- Visual Studio Button -->
                        <Button Content="Visual Studio"
                                Command="{Binding LaunchInVisualStudioCommand}"
                                Background="#E8E8F4"
                                BorderBrush="#CCCCCC"
                                BorderThickness="1"
                                Padding="8,4"
                                Margin="8,0,0,0"
                                ToolTip="Launch in Visual Studio debugger"/>
                    </StackPanel>

                    <StackPanel Margin="0,0,0,16">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Command line"
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center"/>
                            <Button Content="📋"
                                    Command="{Binding CopyCommandLineAsPowerShellCommand}"
                                    VerticalAlignment="Center"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Padding="6,2"
                                    Margin="6,0,0,0"
                                    Cursor="Hand"
                                    ToolTip="Copy as PowerShell"
                                    FontSize="14">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Opacity"
                                                Value="0.6"/>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver"
                                                     Value="True">
                                                <Setter Property="Opacity"
                                                        Value="1.0"/>
                                                <Setter Property="Background"
                                                        Value="#11000000"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </StackPanel>
                        <Border Background="#11000000"
                                Padding="8"
                                Margin="0,4,0,0">
                            <TextBox Text="{Binding CommandLineDisplay, Mode=OneWay}"
                                     Style="{StaticResource SelectableTextBoxStyle}"
                                     TextWrapping="Wrap"/>
                        </Border>
                    </StackPanel>

                    <StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Environment differences"
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center"/>
                            <Button Content="📋"
                                    Command="{Binding CopyEnvironmentDifferencesAsPowerShellCommand}"
                                    VerticalAlignment="Center"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Padding="6,2"
                                    Margin="6,0,0,0"
                                    Cursor="Hand"
                                    ToolTip="Copy as PowerShell"
                                    FontSize="14">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Opacity"
                                                Value="0.6"/>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver"
                                                     Value="True">
                                                <Setter Property="Opacity"
                                                        Value="1.0"/>
                                                <Setter Property="Background"
                                                        Value="#11000000"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </StackPanel>
                        <Border Background="Transparent"
                                Padding="0"
                                Margin="0,4,0,0">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Visibility"
                                            Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasEnvironmentDifferences}"
                                                     Value="True">
                                            <Setter Property="Visibility"
                                                    Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <FlowDocumentScrollViewer Document="{Binding EnvironmentDifferences, Converter={StaticResource EnvironmentDifferencesDocumentConverter}}"
                                                      Background="Transparent"
                                                      Padding="0"
                                                      IsToolBarVisible="False"
                                                      Zoom="100"
                                                      HorizontalScrollBarVisibility="Auto"
                                                      VerticalScrollBarVisibility="Auto"/>
                        </Border>

                        <TextBlock Text="(matches parent environment)"
                                   FontStyle="Italic"
                                   Foreground="Gray"
                                   HorizontalAlignment="Center">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility"
                                            Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasEnvironmentDifferences}"
                                                     Value="False">
                                            <Setter Property="Visibility"
                                                    Value="Visible"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding HasEnvironment}"
                                                     Value="False">
                                            <Setter Property="Visibility"
                                                    Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <TextBlock Text="(no environment captured)"
                                   FontStyle="Italic"
                                   Foreground="Gray"
                                   HorizontalAlignment="Center">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility"
                                            Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasEnvironment}"
                                                     Value="False">
                                            <Setter Property="Visibility"
                                                    Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>

                    <Expander Margin="0,12,0,0">
                        <Expander.Style>
                            <Style TargetType="Expander">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding HasEnvironment}"
                                                 Value="False">
                                        <Setter Property="Visibility"
                                                Value="Collapsed"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Expander.Style>
                        <Expander.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Full environment"
                                           FontWeight="SemiBold"
                                           VerticalAlignment="Center"/>
                                <Button Content="📋"
                                        Command="{Binding CopyFullEnvironmentAsPowerShellCommand}"
                                        VerticalAlignment="Center"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Padding="6,2"
                                        Margin="6,0,0,0"
                                        Cursor="Hand"
                                        ToolTip="Copy as PowerShell (clears all existing variables)"
                                        FontSize="14">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Opacity"
                                                    Value="0.6"/>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver"
                                                         Value="True">
                                                    <Setter Property="Opacity"
                                                            Value="1.0"/>
                                                    <Setter Property="Background"
                                                            Value="#11000000"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>
                            </StackPanel>
                        </Expander.Header>
                        <Border Background="#11000000"
                                Padding="0"
                                Margin="0,8,0,0">
                            <StackPanel>
                                <ItemsControl ItemsSource="{Binding EnvironmentVariables}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0,0,0,2">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBox Grid.Column="0"
                                                         Text="{Binding Key, Mode=OneWay}"
                                                         Style="{StaticResource SelectableKeyTextBoxStyle}"
                                                         Margin="0,0,8,0"/>
                                                <TextBox Grid.Column="1"
                                                         Text="{Binding Value, Mode=OneWay}"
                                                         Style="{StaticResource SelectableTextBoxStyle}"
                                                         TextWrapping="Wrap"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Border>
                    </Expander>
                </StackPanel>
            </ScrollViewer>
        </DataTemplate>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="3*"/>
            <ColumnDefinition Width="2*"/>
        </Grid.ColumnDefinitions>

        <Border Grid.Column="0"
                BorderBrush="#33000000"
                BorderThickness="0,0,1,0"
                Background="White">
            <Grid Grid.IsSharedSizeScope="True">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Border Grid.Row="0"
                        Background="#F3F3F4"
                        Padding="8,6">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="220"
                                              SharedSizeGroup="BinaryColumn"/>
                            <ColumnDefinition Width="90"
                                              SharedSizeGroup="PidColumn"/>
                            <ColumnDefinition Width="90"
                                              SharedSizeGroup="ExitColumn"/>
                            <ColumnDefinition Width="*"
                                              SharedSizeGroup="CommandColumn"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0"
                                   Text="Binary"
                                   FontWeight="Bold"/>
                        <TextBlock Grid.Column="1"
                                   Text="PID"
                                   FontWeight="Bold"/>
                        <TextBlock Grid.Column="2"
                                   Text="Exit"
                                   FontWeight="Bold"/>
                        <TextBlock Grid.Column="3"
                                   Text="Command Line"
                                   FontWeight="Bold"/>
                    </Grid>
                </Border>

                <TreeView x:Name="ProcessTree"
                          Grid.Row="1"
                          ItemsSource="{Binding RootProcesses}"
                          ItemTemplate="{StaticResource ProcessNodeTemplate}"
                          SelectedItemChanged="ProcessTree_OnSelectedItemChanged"
                          ItemContainerStyle="{StaticResource AlignedTreeViewItemStyle}"
                          HorizontalContentAlignment="Stretch"/>
            </Grid>
        </Border>

        <Border Grid.Column="1"
                Background="#FAFAFA">
            <Grid>
                <TextBlock Text="Select a process to see details"
                           FontStyle="Italic"
                           Foreground="Gray"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility"
                                    Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedProcess}"
                                             Value="{x:Null}">
                                    <Setter Property="Visibility"
                                            Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>

                <ContentControl Content="{Binding SelectedProcess}">
                    <ContentControl.Style>
                        <Style TargetType="ContentControl">
                            <Setter Property="Visibility"
                                    Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding SelectedProcess}"
                                             Value="{x:Null}">
                                    <Setter Property="Visibility"
                                            Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ContentControl.Style>
                </ContentControl>
            </Grid>
        </Border>
    </Grid>
</Window>